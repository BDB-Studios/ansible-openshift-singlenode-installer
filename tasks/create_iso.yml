---

- name: Create our install-config.yaml file
  template:
    src: "./templates/install-config.yml.j2"
    dest: "{{ config.base_dir }}/temp/install-config.yaml"
    owner: root
    group: root
    mode: 0644

- name: Create our install ignition config
  command:
    cmd: >
      openshift-install
      --dir={{ config.base_dir }}/temp
      create
      single-node-ignition-config
  args:
    creates: "{{ config.base_dir }}/temp/bootstrap-in-place-for-live-iso.ign"

# yamllint disable rule:line-length
- name: Create our network interface nmconnection file
  template:
    src: "./templates/interface.nmconnection.j2"
    dest: "{{ config.base_dir }}/temp/{{ openshift.network.interface }}.nmconnection"
    owner: root
    group: root
    mode: 0644
# yamllint enable rule:line-length
-
- name: Create our ignition config file
  template:
    src: "./templates/networking-ignition.yml.j2"
    dest: "{{ config.base_dir }}/temp/networking-ignition.yaml"
    owner: root
    group: root
    mode: 0644

- name: Copy our single-node-ignition-config.ig file to our iso directory
  command:
    cmd: >
      cp {{ config.base_dir }}/temp/bootstrap-in-place-for-live-iso.ign
      {{ config.base_dir }}/iso/iso.ign
  args:
    creates: "{{ config.base_dir }}/iso/iso.ign"

- name: Create our CoreOS boot iso
  shell: >
      podman run --privileged --rm -v
      /dev:/dev -v /run/udev:/run/udev
      -v {{ config.base_dir }}/iso:/data
      -w /data quay.io/coreos/coreos-installer:release
      iso
      ignition
      embed
      -fi iso.ign
      rhcos-live.x86_64.iso
  # noqa no-changed-when

# yamllint disable rule:line-length
- name: Add our network customisations
  shell: >
      coreos-installer
      iso customize
      --network-keyfile {{ config.base_dir }}/temp/{{ openshift.network.interface }}.nmconnection
      {{ config.base_dir }}/iso/rhcos-live.x86_64.iso
# noqa no-changed-when
# yamllint enable rule:line-length
